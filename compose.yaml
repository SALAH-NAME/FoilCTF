# REFERENCE: https://compose-spec.github.io/compose-spec/03-compose-file.html
# NOTE: Env interpolation is only supported on docker-compose's engine
name: foilctf

services:
  gateway:
    build:
      tags:
        - "foilctf/gateway:latest"
      context: ./app/gateway/
      dockerfile: Containerfile
    environment:
      - PORT=${GATEWAY_PORT:-443}
      - ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET:-changeme-secret-key}
      - SERVICE_NAME=${GATEWAY_SERVICE_NAME:-gateway}
      - LOG_LEVEL=${LOG_LEVEL:-warn}
      - CERT_DIR=/certs
      - GATEWAY_USER_URL=http://user:${USER_SERVICE_PORT:-3001}
      - GATEWAY_CHALLENGE_URL=http://challenge:${CHALLENGE_SERVICE_PORT:-3002}
      - GATEWAY_CHAT_URL=http://chat:${CHAT_SERVICE_PORT:-3003}
      - GATEWAY_NOTIFICATION_URL=http://notification:${NOTIFICATION_SERVICE_PORT:-3004}
      - GATEWAY_EVENT_URL=http://event:${EVENT_SERVICE_PORT:-3005}
      - GATEWAY_SANDBOX_URL=http://sandbox:${SANDBOX_SERVICE_PORT:-3006}
    networks:
      - foilctf_net
    ports:
      - "3443:${GATEWAY_PORT:-443}" # For development access
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- https://localhost:443/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    volumes:
      - gateway-certs:/certs
    restart: unless-stopped

  user:
    container_name: foilctf_user
    build:
      tags:
        - "foilctf/user:latest"
      context: ./app/user/
      dockerfile: Containerfile
    environment:
      - PORT=${USER_PORT:-3001}
      - DATABASE_URL=postgresql://${DATABASE_DEVELOPER_USER}:${DATABASE_DEVELOPER_PASS}@database:5432/${DATABASE_NAME:-foilctf}
      - ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET:?ACCESS_TOKEN_SECRET must be set}
      - REFRESH_TOKEN_SECRET=${REFRESH_TOKEN_SECRET:?REFRESH_TOKEN_SECRET must be set}
      - ACCESS_TOKEN_EXPIRY=${ACCESS_TOKEN_EXPIRY:-15m}
      - REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY:-7d}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-2097152}
      - AVATARS_DIR=${AVATARS_DIR:-./uploads/avatars}
    volumes:
      - user-avatars:/app/uploads/avatars
    networks:
      - foilctf_net
    ports:
      - "3001:3001" # For development access
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3001/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  challenge:
    container_name: foilctf_challenge
    build:
      tags:
        - "foilctf/challenge:latest"
      context: ./app/challenge/
      dockerfile: Containerfile
    environment:
      - API_PORT=${CHALLENGE_PORT:-3002}
      - API_HOST=localhost
      - API_ORIGINS_WHITELIST=${API_ORIGINS_WHITELIST:-http://localhost:443,http://127.0.0.1:443}
      - DATABASE_HOST=database
      - DATABASE_PORT=5432
      - DATABASE_USER=${DATABASE_DEVELOPER_USER:?DATABASE_DEVELOPER_USER must be set}
      - DATABASE_PASS=${DATABASE_DEVELOPER_PASS:?DATABASE_DEVELOPER_PASS must be set}
      - DATABASE_NAME=${DATABASE_NAME:-foilctf}
    networks:
      - foilctf_net
    ports:
      - "3002:3002" # For development access
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3002/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # PostgreSQL Database Service
  # REFERENCE: https://github.com/docker-library/docs/blob/master/postgres/README.md
  database:
    container_name: foilctf_database
    build:
      tags:
        - "foilctf/database:latest"
      context: app/database/
      dockerfile: Containerfile
    environment: # TODO(xenobas): POSTGRES_HOST_AUTH_METHOD, POSTGRES_INITDB_ARGS for networking
      # Data
      PGDATA: ${DATABASE_VOLUME_DATA_MOUNT:-/var/lib/postgresql/data}
      PGLOGS: ${DATABASE_LOGS:-/var/lib/postgresql/logs}
      # Connection
      POSTGRES_DB: ${DATABASE_NAME:-foilctf}
      POSTGRES_USER: ${DATABASE_ADMIN_USER:-postgres}
      POSTGRES_PASSWORD: ${DATABASE_ADMIN_PASS:?DATABASE_ADMIN_PASS must be set}
      # Scripts
      DATABASE_MIGRATIONS_MOUNT: ${DATABASE_VOLUME_MIGRATIONS_MOUNT:-/migrations}
      # Users
      DATABASE_DEVELOPER_USER: ${DATABASE_DEVELOPER_USER:?DATABASE_DEVELOPER_USER must be set}
      DATABASE_DEVELOPER_PASS: ${DATABASE_DEVELOPER_PASS:?DATABASE_DEVELOPER_PASS must be set}
    volumes:
      - postgres:${DATABASE_VOLUME_DATA_MOUNT}
      - type: volume
        source: migrations
        target: ${DATABASE_VOLUME_MIGRATIONS_MOUNT}
        read_only: true
    networks:
      - foilctf_net
    ports:
      - "5432:5432" # For development access
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'pg_isready -d "$POSTGRES_DB" -U "$POSTGRES_USER" && psql -d "$POSTGRES_DB" -U "$POSTGRES_USER" -tAc "SELECT 1 FROM users LIMIT 1" > /dev/null 2>&1',
        ]
      interval: "10s"
      timeout: "5s"
      retries: 5
      start_period: 30s
    restart: unless-stopped

  web:
    container_name: foilctf_web
    build:
      tags:
        - "foilctf/web:latest"
      context: ./app/web/
      dockerfile: Containerfile
    environment:
      - PORT=${WEB_PORT:-3000}
      - ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET:?ACCESS_TOKEN_SECRET must be set}

    networks:
      - foilctf_net
    ports:
      - "3000:3000" # For development access
    depends_on:
      - gateway
    restart: unless-stopped

  chat:
    container_name: foilctf_chat
    build:
      tags:
        - "foilctf/chat:latest"
      context: ./app/chat/
      dockerfile: Containerfile
    environment:
      - PORT=${CHAT_SERVICE_PORT:-3003}
      - ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET:-changeme-secret-key}
      - DB_HOST=database
      - DB_PORT=5432
      - DB_USER=${DATABASE_DEVELOPER_USER:?DATABASE_DEVELOPER_USER must be set}
      - DB_PASS=${DATABASE_DEVELOPER_PASS:?DATABASE_DEVELOPER_PASS must be set}
      - DB_NAME=${DATABASE_NAME:-foilctf}
    networks:
      - foilctf_net
    ports:
      - "3003:3003" # For development access
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3003/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  notification:
    container_name: foilctf_notification
    build:
      tags:
        - "foilctf/notification:latest"
      context: ./app/notification/
      dockerfile: Containerfile
    environment:
      - PORT=${NOTIFICATION_SERVICE_PORT:-3004}
      - SECRET_KEY=${ACCESS_TOKEN_SECRET:-changeme-secret-key}
      - DB_HOST=database
      - DB_PORT=5432
      - DB_USER=${DATABASE_DEVELOPER_USER:?DATABASE_DEVELOPER_USER must be set}
      - DB_PASS=${DATABASE_DEVELOPER_PASS:?DATABASE_DEVELOPER_PASS must be set}
      - DB_NAME=${DATABASE_NAME:-foilctf}
    networks:
      - foilctf_net
    ports:
      - "3004:3004" # For development access
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3004/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  event:
    container_name: foilctf_event
    build:
      tags:
        - "foilctf/event:latest"
      context: ./app/event/
      dockerfile: Containerfile
    environment:
      - PORT=${EVENT_SERVICE_PORT:-3005}
      - SECRET_KEY=${ACCESS_TOKEN_SECRET:-changeme-secret-key}
      - DB_HOST=database
      - DB_PORT=5432
      - DB_USER=${DATABASE_DEVELOPER_USER:?DATABASE_DEVELOPER_USER must be set}
      - DB_PASS=${DATABASE_DEVELOPER_PASS:?DATABASE_DEVELOPER_PASS must be set}
      - DB_NAME=${DATABASE_NAME:-foilctf}
    networks:
      - foilctf_net
    ports:
      - "3005:3005" # For development access
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3005/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  sandbox:
    container_name: foilctf_sandbox
    build:
      tags:
        - "foilctf/sandbox:latest"
      context: ./app/sandbox/
      dockerfile: Containerfile
    environment:
      - SERVER_ADDRESS=:${SANDBOX_SERVICE_PORT:-3006}
      - DATABASE_URI=postgresql://${DATABASE_DEVELOPER_USER}:${DATABASE_DEVELOPER_PASS}@database:5432/${DATABASE_NAME:-foilctf}
      - PODMAN_URI=unix:///run/podman/podman.sock
      - PODMAN_DIR_IMAGES=${SANDBOX_IMAGES_DIR:-/data/images}
      - PODMAN_DIR_HEALTH=/data/health
    volumes:
      - sandbox-images:/data/images
      - ${PODMAN_SOCKET:-/run/podman/podman.sock}:/run/podman/podman.sock:ro
    networks:
      - foilctf_net
    ports:
      - "3006:3006" # For development access
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3006/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  prometheus:
    image: docker.io/prom/prometheus:latest
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-lifecycle"
      - "--web.external-url=https://localhost:3443/monitoring/prometheus"
      - "--web.route-prefix=/monitoring/prometheus"
    volumes:
      - ./monitoring/promethues/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - foilctf_net
    depends_on:
      - gateway
    restart: unless-stopped

  grafana:
    image: docker.io/grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_HTTP_PORT=9091
      - GF_SERVER_ROOT_URL=https://localhost:3443/monitoring/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      - GF_SECURITY_CSRF_TRUSTED_ORIGINS=localhost:3443,gateway:443,https://localhost:3443,https://gateway:443
      - GF_LIVE_ALLOWED_ORIGINS=https://localhost:3443,https://gateway:443
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks:
      - foilctf_net
    depends_on:
      - prometheus
    restart: unless-stopped

networks:
  foilctf_net:
    name: foilctf_net
    driver: bridge

volumes:
  gateway-certs:
  user-avatars:
  sandbox-images:
  prometheus-data:
  grafana-data:
  postgres:
  migrations:
    driver_opts:
      o: "bind"
      type: "none"
      device: "${DATABASE_VOLUME_MIGRATIONS_DIR?}"
