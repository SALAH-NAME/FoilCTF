# REFERENCE: https://compose-spec.github.io/compose-spec/03-compose-file.html
# NOTE: Env interpolation is only supported on docker-compose's engine
name: foilctf

services:
  gateway:
    build:
      tags:
        - "foilctf/gateway:latest"
      context: ./app/gateway/
      dockerfile: Containerfile
    environment:
      - PORT=${GATEWAY_PORT:-3000}
      - JWT_SECRET=${JWT_SECRET:-changeme-secret-key}
      - SERVICE_NAME=${GATEWAY_SERVICE_NAME:-gateway}
      - LOG_LEVEL=${LOG_LEVEL:-warn}
    networks:
      - foilctf_net
    ports:
      - "3000:3000" # For development access
    restart: unless-stopped

  # PostgreSQL Database Service
  # REFERENCE: https://github.com/docker-library/docs/blob/master/postgres/README.md
  database:
    container_name: foilctf_database
    build:
      tags:
        - "foilctf/database:latest"
      context: app/database/
      dockerfile: Containerfile
    environment: # TODO(xenobas): POSTGRES_HOST_AUTH_METHOD, POSTGRES_INITDB_ARGS for networking
      # Data
      PGDATA: ${DATABASE_VOLUME_DATA_MOUNT:-/var/lib/postgresql/data}
      PGLOGS: ${DATABASE_LOGS:-/var/lib/postgresql/logs}
      # Connection
      POSTGRES_DB: ${DATABASE_NAME:-foilctf}
      POSTGRES_USER: ${DATABASE_ADMIN_USER:-postgres}
      POSTGRES_PASSWORD: ${DATABASE_ADMIN_PASS:?DATABASE_ADMIN_PASS must be set}
      # Scripts
      DATABASE_MIGRATIONS_MOUNT: ${DATABASE_VOLUME_MIGRATIONS_MOUNT:-/migrations}
      # Users
      DATABASE_DEVELOPER_USER: ${DATABASE_DEVELOPER_USER:?DATABASE_DEVELOPER_USER must be set}
      DATABASE_DEVELOPER_PASS: ${DATABASE_DEVELOPER_PASS:?DATABASE_DEVELOPER_PASS must be set}
    volumes:
      - postgres:${DATABASE_VOLUME_DATA_MOUNT}
      - type: volume
        source: migrations
        target: ${DATABASE_VOLUME_MIGRATIONS_MOUNT}
        read_only: true
    networks:
      - foilctf_net
    ports:
      - "5432:5432"  # For development access
    healthcheck:
      test: ["CMD-SHELL", 'pg_isready -d "$POSTGRES_DB" -U "$POSTGRES_USER" && psql -d "$POSTGRES_DB" -U "$POSTGRES_USER" -tAc "SELECT 1 FROM users LIMIT 1" > /dev/null 2>&1']
      interval: "10s"
      timeout: "5s"
      retries: 5
      start_period: 30s
    restart: unless-stopped

  prometheus:
    image: docker.io/prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.external-url=http://localhost:3000/monitoring/prometheus'
      - '--web.route-prefix=/monitoring/prometheus'
    volumes:
      - ./monitoring/promethues/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - foilctf_net
    depends_on:
      - gateway
    restart: unless-stopped

  grafana:
    image: docker.io/grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_HTTP_PORT=9091
      - GF_SERVER_ROOT_URL=http://localhost:3000/monitoring/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks:
      - foilctf_net
    depends_on:
      - prometheus
    restart: unless-stopped

networks:
  foilctf_net:
    name: foilctf_net
    driver: bridge

volumes:
  postgres:
  migrations:
    driver_opts:
      o: "bind"
      type: "none"
      device: "${DATABASE_VOLUME_MIGRATIONS_DIR?}"
  sandbox-images:
  prometheus-data:
  grafana-data:
