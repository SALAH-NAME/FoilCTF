groups:
  - name: foilctf_alerts
    rules:
      - alert: GatewayDown
        expr: up{job="gateway"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Gateway Instance is down"
          description: "Gateway instance has been down for more than 1 minute."

      - alert: GatewayHighRequestLatency
        expr: (sum(rate(gateway_http_request_duration_seconds_sum{status!~"0|101"}[5m])) by (instance)) / (sum(rate(gateway_http_request_duration_seconds_count{status!~"0|101"}[5m])) by (instance)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency on Gateway"
          description: "Average latency (excluding WebSockets) is above 0.5s for more than 5 minutes."

      - alert: ChatDown
        expr: up{job="chat"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Chat service is down"
          description: "Chat service has been down for more than 1 minute."

      - alert: ChatHighWebSocketConnections
        expr: chat_websocket_connected_clients > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High number of WebSocket connections on Chat"
          description: "Chat service has more than 100 active WebSocket connections for 5 minutes."

      - alert: ChatWebSocketNoTraffic
        expr: (sum(rate(chat_websocket_messages_total[10m])) == 0) and (chat_websocket_connected_clients > 0)
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "No WebSocket traffic on Chat"
          description: "Chat service is processing 0 messages despite having active connections for 10 minutes."

      - alert: NotificationDown
        expr: up{job="notification"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Notification service is down"
          description: "Notification service has been down for more than 1 minute."

      - alert: NotificationHighRequestLatency
        expr: (sum(rate(notification_http_request_duration_seconds_sum{status!~"0|101"}[5m])) by (instance)) / (sum(rate(notification_http_request_duration_seconds_count{status!~"0|101"}[5m])) by (instance)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency on Notification"
          description: "Average latency is above 0.5s for more than 5 minutes."

      - alert: NotificationHighWebSocketConnections
        expr: notification_websocket_connected_clients > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High number of WebSocket connections on Notification"
          description: "Notification service has more than 100 active WebSocket connections for 5 minutes."

      - alert: NotificationWebSocketNoTraffic
        expr: (sum(rate(notification_websocket_messages_total[10m])) == 0) and (notification_websocket_connected_clients > 0)
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "No WebSocket traffic on Notification"
          description: "Notification service is processing 0 messages despite having active connections for 10 minutes."

      - alert: UserDown
        expr: up{job="user"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "User service is down"
          description: "User service has been down for more than 1 minute."

      - alert: UserHighRequestLatency
        expr: (sum(rate(user_requests_latency_sum[5m])) by (instance)) / (sum(rate(user_requests_latency_count[5m])) by (instance)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency on User"
          description: "Average latency is above 0.5s for more than 5 minutes."

      - alert: ChallengeDown
        expr: up{job="challenge"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Challenge service is down"
          description: "Challenge service has been down for more than 1 minute."

      - alert: ChallengeHighRequestLatency
        expr: (sum(rate(requests_latency_sum[5m])) by (instance)) / (sum(rate(requests_latency_count[5m])) by (instance)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency on Challenge"
          description: "Average latency is above 0.5s for more than 5 minutes."

      - alert: EventDown
        expr: up{job="event"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Event service is down"
          description: "Event service has been down for more than 1 minute."

      - alert: EventHighRequestLatency
        expr: (sum(rate(event_http_request_duration_seconds_sum[5m])) by (instance)) / (sum(rate(event_http_request_duration_seconds_count[5m])) by (instance)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency on Event"
          description: "Average latency is above 0.5s for more than 5 minutes."

      - alert: SandboxDown
        expr: up{job="sandbox"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Sandbox service is down"
          description: "Sandbox service has been down for more than 1 minute."

